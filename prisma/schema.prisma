generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  price       Decimal 
  pricePedidosYa Decimal?
  priceRappi     Decimal?
  priceMP        Decimal?
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  image       String?
  isActive    Boolean  @default(true)
  isPromo        Boolean  @default(false)
  promoDiscount  Float    @default(0)
  isPromoPY      Boolean  @default(false)
  promoDiscountPY Float   @default(0)
  isPromoRappi   Boolean  @default(false)
  promoDiscountRappi Float @default(0)
  isPromoMP      Boolean  @default(false)
  promoDiscountMP Float    @default(0)
  recipe      RecipeItem[]
  sales       SaleItem[]
  showPublic  Boolean  @default(true)
  
  // Relations for extras
  allowedExtras ProductExtra[] @relation("MainProduct")
  usedAsExtra   ProductExtra[] @relation("ExtraProduct")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  products  Product[]
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Ingredient {
  id          String   @id @default(uuid())
  name        String
  unit        String   // kg, liter, unit
  cost        Decimal 
  stock       Decimal 
  minStock    Decimal  // Reorder point
  recipeItems RecipeItem[]
  wasteLogs   WasteLog[]
  priceHistory PriceHistory[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PriceHistory {
  id           String     @id @default(uuid())
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  cost         Decimal
  date         DateTime   @default(now())
}

model RecipeItem {
  id           String     @id @default(uuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Decimal    // Amount of ingredient per product
}

model Sale {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  total       Decimal 
  discount    Decimal  @default(0)
  paymentMethod String // Cash, MP, Transfer
  channel     String   // Rappi, WhatsApp, Counter
  items       SaleItem[]
  clientName  String?   // Name for the ticket (Walk-in)
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  status      String    @default("COMPLETED") // COMPLETED, CANCELLED, REFUNDED
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal // Price at the moment of sale
}

model Expense {
  id          String   @id @default(uuid())
  date        DateTime
  category    String   // Rent, Utilities, Salaries, Packaging
  amount      Decimal 
  description String?
  isFixed     Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model Customer {
  id        String   @id @default(uuid())
  name      String?
  phone     String?  @unique
  email     String?
  sales     Sale[]
  lastPurchase DateTime?
  totalSpent Decimal @default(0)
  createdAt   DateTime @default(now())
}

model WasteLog {
  id           String   @id @default(uuid())
  date         DateTime @default(now())
  description  String
  cost         Decimal
  ingredientId String?
  ingredient   Ingredient? @relation(fields: [ingredientId], references: [id])
  quantity     Decimal? // Amount lost if linked to ingredient
  createdAt    DateTime @default(now())
}

model BrainKnowledge {
  id        String   @id @default(uuid())
  content   String   
  category  String?  // 'operation', 'recipe', 'history'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PlatformConfig {
  id         String   @id @default(uuid())
  name       String   @unique // RAPPI, PEYA, MERCADOPAGO, MOSTRADOR, etc.
  commission Float    @default(0) // Percentage, e.g., 35.0
  updatedAt  DateTime @updatedAt
}

model ProductExtra {
  id             String  @id @default(uuid())
  mainProductId  String
  mainProduct    Product @relation("MainProduct", fields: [mainProductId], references: [id])
  extraProductId String
  extraProduct   Product @relation("ExtraProduct", fields: [extraProductId], references: [id])

  @@unique([mainProductId, extraProductId])
}

model StoreHours {
  id        String   @id @default(uuid())
  dayOfWeek Int      @unique // 0 for Sunday, 1 for Monday, etc.
  isOpen    Boolean  @default(true)
  shifts    Json     // Array of { openTime: string, closeTime: string }
  updatedAt DateTime @updatedAt
}
